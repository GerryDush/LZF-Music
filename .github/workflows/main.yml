name: Build and Release Flutter App

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # --- æ¡Œé¢ç«¯: macOS ---
  build-macos:
    runs-on: macos-26
    strategy:
      matrix:
        arch: [x86_64, arm64, universal]

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Switch EXCLUDED_ARCHS
        run: |
          PBXPROJ="macos/Runner.xcodeproj/project.pbxproj"
          ARCH=${{ matrix.arch }}
          if [[ "$ARCH" == "universal" ]]; then
            sed -i '' 's/EXCLUDED_ARCHS = .*;/EXCLUDED_ARCHS = "";/g' "$PBXPROJ"
          elif [[ "$ARCH" == "x86_64" ]]; then
            sed -i '' 's/EXCLUDED_ARCHS = .*;/EXCLUDED_ARCHS = "arm64";/g' "$PBXPROJ"
          elif [[ "$ARCH" == "arm64" ]]; then
            sed -i '' 's/EXCLUDED_ARCHS = .*;/EXCLUDED_ARCHS = "x86_64";/g' "$PBXPROJ"
          fi

      - run: dart pub global activate fastforge
      - run: npm install -g appdmg

      - run: fastforge package --platform macos --targets dmg

      - name: Get Flutter version
        id: get_version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d+ -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Rename DMG with architecture
        run: |
          ARCH=${{ matrix.arch }}
          VERSION=${{ steps.get_version.outputs.version }}
          SRC="dist/$VERSION/lzf_music-$VERSION-macos.dmg"
          DST="dist/$VERSION/LZF-Music-$VERSION-macos-$ARCH.dmg"
          mv "$SRC" "$DST"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-dmg
          path: dist/${{ steps.get_version.outputs.version }}/LZF-Music-${{ steps.get_version.outputs.version }}-macos-${{ matrix.arch }}.dmg
          retention-days: 1

  # --- æ¡Œé¢ç«¯: Windows ---
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install Inno Setup 6
        run: |
          $url = "https://jrsoftware.org/download.php/is.exe"
          $output = "${{ runner.temp }}\innosetup.exe"
          Invoke-WebRequest -Uri $url -OutFile $output
          Start-Process -FilePath $output -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait
          $innoPath = "C:\Program Files (x86)\Inno Setup 6"
          echo "$innoPath" >> $env:GITHUB_PATH

      - name: Copy Chinese language pack
        run: |
          $sourceFile = "windows\packaging\exe\ChineseSimplified.isl"
          $targetDir = "C:\Program Files (x86)\Inno Setup 6\Languages"
          $targetFile = "$targetDir\ChineseSimplified.isl"
          if (Test-Path $sourceFile) { Copy-Item $sourceFile $targetFile -Force }

      - name: Install fastforge
        run: dart pub global activate fastforge

      - name: Get Flutter version
        id: get_version
        run: |
          $VERSION = (Get-Content pubspec.yaml | Select-String "version:" | ForEach-Object { $_ -replace "version:\s*", "" } | ForEach-Object { $_ -replace "\+.*", "" })
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT

      - name: Package Windows exe
        run: fastforge package --platform windows --targets exe

      - name: Rename Windows installer
        run: |
          $VERSION = "${{ steps.get_version.outputs.version }}"
          $DIST_DIR = "dist\$VERSION"
          $INSTALLER_NAME = "LZF-Music-$VERSION-windows-x64-setup.exe"
          Get-ChildItem "$DIST_DIR" -Filter "*.exe" | ForEach-Object {
            Copy-Item $_.FullName $INSTALLER_NAME -Force
          }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: LZF-Music-${{ steps.get_version.outputs.version }}-windows-x64-setup.exe
          retention-days: 1

  build-mobile:
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get Flutter version
        id: get_version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d+ -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - run: flutter pub get

      # ==========================================
      # 1. æ„å»º Android
      # ==========================================
      - name: Build Android APKs
        run: |
          # 1. æ„å»º Universal åŒ…
          flutter build apk --release
          # 2. æ„å»ºåˆ†æ¶æ„åŒ…
          flutter build apk --release --split-per-abi

      - name: Rename Android APKs
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          mkdir -p dist_android
          
          BASE_DIR="build/app/outputs/flutter-apk"
          
          # ç§»åŠ¨å¹¶é‡å‘½å
          mv "$BASE_DIR/app-release.apk" "dist_android/LZF-Music-$VERSION-android-universal.apk"
          mv "$BASE_DIR/app-arm64-v8a-release.apk" "dist_android/LZF-Music-$VERSION-android-arm64-v8a.apk"
          mv "$BASE_DIR/app-armeabi-v7a-release.apk" "dist_android/LZF-Music-$VERSION-android-armeabi-v7a.apk"
          mv "$BASE_DIR/app-x86_64-release.apk" "dist_android/LZF-Music-$VERSION-android-x86_64.apk"

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apks
          path: dist_android/*.apk
          retention-days: 1

      # ==========================================
      # 2. æ„å»º iOS
      # ==========================================
      - name: Build iOS (No Codesign)
        run: |
          # --no-codesign å…è®¸åœ¨æ²¡æœ‰è¯ä¹¦çš„æƒ…å†µä¸‹æ„å»º release åŒ…
          flutter build ios --release --no-codesign

      - name: Package iOS IPA
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          mkdir -p dist_ios
          mkdir -p Payload
          
          # å¤åˆ¶ Runner.app åˆ° Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          
          # å‹ç¼©ç”Ÿæˆ IPA
          zip -r "dist_ios/LZF-Music-$VERSION-ios.ipa" Payload

      - name: Upload iOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: dist_ios/*.ipa
          retention-days: 1

  # --- ç»Ÿä¸€å‘å¸ƒ ---
  create-release:
    needs: [build-macos, build-windows, build-mobile]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      # æ•´ç†æ–‡ä»¶
      - name: Prepare Release Files
        run: |
          mkdir -p release_files
          
          # æŸ¥æ‰¾å¹¶ç§»åŠ¨æ‰€æœ‰ç›¸å…³æ–‡ä»¶
          find artifacts -name "*.dmg" -exec cp {} release_files/ \;
          find artifacts -name "*.exe" -exec cp {} release_files/ \;
          find artifacts -name "*.apk" -exec cp {} release_files/ \;
          find artifacts -name "*.ipa" -exec cp {} release_files/ \;
          
          echo "Listing release files:"
          ls -R release_files/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ğŸ‰ å‘å¸ƒç‰ˆæœ¬ ${{ github.ref_name }}
            
            ğŸ–¥ï¸ Windows ç‰ˆæœ¬
            â€¢ å®‰è£…ç¨‹åºï¼šæ”¯æŒ Windows 10/11 (x64)
            â€¢ åŠŸèƒ½ï¼šè‡ªåŠ¨åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
            â€¢ æ™ºèƒ½éŸ³é¢‘æ§åˆ¶ï¼š
            â€¢ æ‹”æ‰è€³æœºè‡ªåŠ¨æš‚åœæ’­æ”¾
            â€¢ è€³æœºæŒ‰é’®æ§åˆ¶æ’­æ”¾ / æš‚åœ / åˆ‡æ­Œ
            â€¢ âŒ¨ï¸ å¿«æ·é”®æ”¯æŒï¼š
            â€¢ ç©ºæ ¼ï¼šæ’­æ”¾ / æš‚åœ
            â€¢ Ctrl âŒ˜ + å·¦å³æ–¹å‘é”®ï¼šå¿«è¿› / å¿«é€€
            â€¢ Ctrl âŒ˜ + ä¸Šä¸‹æ–¹å‘é”®ï¼šä¸Šä¸€é¦– / ä¸‹ä¸€é¦–
            â€¢ æ’­æ”¾é¡µé¢åŠ¨ç”»ä¼˜åŒ–ï¼šä¿®æ”¹äº†æ’­æ”¾é¡µé¢çš„è¿›å…¥åŠ¨ç”»
            â€¢ æ›´å¤šçŠ¶æ€ä¿å­˜ï¼šæ’­æ”¾çŠ¶æ€ã€åˆ—è¡¨ä½ç½®ã€ä¾§è¾¹æ çŠ¶æ€ç­‰
            â€¢ æ”¯æŒä¸»é¢˜åˆ‡æ¢
            â€¢ æ”¯æŒèƒŒæ™¯é«˜æ–¯æ¨¡ç³Šä¸é€æ˜åº¦è°ƒæ•´

            ğŸ macOS ç‰ˆæœ¬
            â€¢ Intel (x86_64)ï¼šé€‚ç”¨äº Intel Mac
            â€¢ Apple Silicon (arm64)ï¼šé€‚ç”¨äº M1/M2 Mac
            â€¢ é€šç”¨ç‰ˆ (universal)ï¼šåŒæ—¶æ”¯æŒ Intel å’Œ Apple Silicon
            â€¢ æ™ºèƒ½éŸ³é¢‘æ§åˆ¶ï¼š
            â€¢ æ‹”æ‰è€³æœºè‡ªåŠ¨æš‚åœæ’­æ”¾
            â€¢ è€³æœºæŒ‰é’®æ§åˆ¶æ’­æ”¾ / æš‚åœ / åˆ‡æ­Œ
            â€¢ âŒ¨ï¸ å¿«æ·é”®æ”¯æŒï¼š
            â€¢ ç©ºæ ¼ï¼šæ’­æ”¾ / æš‚åœ
            â€¢ Command âŒ˜ + å·¦å³æ–¹å‘é”®ï¼šå¿«è¿› / å¿«é€€
            â€¢ Command âŒ˜ + ä¸Šä¸‹æ–¹å‘é”®ï¼šä¸Šä¸€é¦– / ä¸‹ä¸€é¦–
            â€¢ æ”¯æŒä¸»é¢˜åˆ‡æ¢
            â€¢ èƒŒæ™¯é«˜æ–¯æ¨¡ç³Šä¸é€æ˜åº¦è°ƒæ•´

            ğŸ“± iOS ç‰ˆæœ¬
            â€¢ é€‚ç”¨ç‰ˆæœ¬ï¼šiOS 14 åŠä»¥ä¸Š
            â€¢ æ™ºèƒ½éŸ³é¢‘æ§åˆ¶ï¼š
            â€¢ æ‹”æ‰è€³æœºè‡ªåŠ¨æš‚åœæ’­æ”¾
            â€¢ è€³æœº / è“ç‰™æŒ‰é’®æ§åˆ¶æ’­æ”¾ / æš‚åœ / åˆ‡æ­Œ
            â€¢ æ§åˆ¶ä¸­å¿ƒæ’­æ”¾æ”¯æŒ
            â€¢ èƒŒæ™¯æ’­æ”¾æ”¯æŒ
            â€¢ æ”¯æŒä¸»é¢˜åˆ‡æ¢
            â€¢ æ”¯æŒå°ç»„ä»¶æ˜¾ç¤ºå½“å‰æ’­æ”¾æ­Œæ›²åŠæ§åˆ¶

            âœ¨ æ›´æ–°å†…å®¹
            â€¢ æ”¯æŒæŒ‰ç…§æ·»åŠ æ—¶é—´æ’åº
            â€¢ æ”¯æŒæ‰¹é‡é€‰æ‹©åˆ é™¤
            â€¢ ä¼˜åŒ–éŸ³é¢‘æ’­æ”¾ç¨³å®šæ€§ä¸è€³æœºæ§åˆ¶ä½“éªŒ
            â€¢ æ–°å¢æ”¯æŒ M4A ä¸ ALAC æ ¼å¼çš„æ¯”ç‰¹ç‡ä¸é‡‡æ ·ç‡è¯»å–
            â€¢ æ”¯æŒç³»ç»Ÿæ‰˜ç›˜ä¸åå°è¿è¡Œ
            â€¢ æ–°å¢æ’­æ”¾çŠ¶æ€ä¿å­˜ï¼šé€€å‡ºåº”ç”¨åè‡ªåŠ¨ä¿å­˜æ’­æ”¾è¿›åº¦ã€éŸ³é‡ã€æ’­æ”¾æ¨¡å¼
            â€¢ æ–°å¢è‡ªåŠ¨å®šä½å½“å‰æ­Œæ›²ï¼šåˆ‡æ¢æ­Œæ›²æ—¶åˆ—è¡¨è‡ªåŠ¨æ»šåŠ¨åˆ°å½“å‰æ’­æ”¾ä½ç½®
            â€¢ æ–°å¢æ­Œæ›²å¯¼å…¥è¿›åº¦æ˜¾ç¤ºï¼šå¯æŸ¥çœ‹å¯¼å…¥çš„å®æ—¶è¿›åº¦ä¸å®ŒæˆçŠ¶æ€
            â€¢ æ–°å¢æ­Œè¯åŠŸèƒ½ï¼šæ”¯æŒ LRCã€TTML æ ¼å¼è§£æï¼Œæ”¯æŒé€å­—æ­Œè¯æ˜¾ç¤º
            â€¢ æ–°å¢å°é¢å¯¼å…¥åŠŸèƒ½ï¼šæ”¯æŒé€‰æ‹©å›¾ç‰‡è¦†ç›–æ—§å°é¢
            â€¢ æ’­æ”¾é¡µé¢åŠ¨ç”»ä¼˜åŒ–ï¼Œæ›´å¤šçŠ¶æ€ä¿å­˜ï¼ˆåˆ—è¡¨ä½ç½®ã€ä¾§è¾¹æ å±•å¼€çŠ¶æ€ï¼‰
            â€¢ æ”¯æŒä¸»é¢˜åˆ‡æ¢
            â€¢ æ”¯æŒèƒŒæ™¯é«˜æ–¯æ¨¡ç³Šä¸é€æ˜åº¦è°ƒæ•´

            â¸»

            ğŸ‰ Release ${{ github.ref_name }}

            ğŸ–¥ï¸ Windows
            â€¢ Installer: Supports Windows 10/11 (x64)
            â€¢ Feature: Auto-create desktop shortcut
            â€¢ Smart Audio Control:
            â€¢ Auto-pause when headphones are unplugged
            â€¢ Headset buttons for play / pause / next / previous
            â€¢ âŒ¨ï¸ Keyboard Shortcuts:
            â€¢ Space: Play / Pause
            â€¢ Ctrl âŒ˜ + Left/Right Arrow: Seek backward / forward
            â€¢ Ctrl âŒ˜ + Up/Down Arrow: Previous / Next track
            â€¢ Playback page animation optimized
            â€¢ More state persistence: playback state, playlist position, sidebar state
            â€¢ Theme switching support
            â€¢ Background blur & transparency adjustment

            ğŸ macOS
            â€¢ Intel (x86_64): for Intel-based Macs
            â€¢ Apple Silicon (arm64): for M1/M2 Macs
            â€¢ Universal: supports both Intel & Apple Silicon
            â€¢ Smart Audio Control:
            â€¢ Auto-pause when headphones are unplugged
            â€¢ Headset buttons for play / pause / next / previous
            â€¢ âŒ¨ï¸ Keyboard Shortcuts:
            â€¢ Space: Play / Pause
            â€¢ Command âŒ˜ + Left/Right Arrow: Seek backward / forward
            â€¢ Command âŒ˜ + Up/Down Arrow: Previous / Next track
            â€¢ Theme switching support
            â€¢ Background blur & transparency adjustment

            ğŸ“± iOS
            â€¢ Supported: iOS 14+
            â€¢ Smart Audio Control:
            â€¢ Auto-pause when headphones are unplugged
            â€¢ Headset / Bluetooth buttons for play / pause / next / previous
            â€¢ Control Center playback support
            â€¢ Background playback support
            â€¢ Theme switching support
            â€¢ Home screen widget shows current track & controls

            âœ¨ Whatâ€™s New
            â€¢ Support sorting by added time
            â€¢ Batch delete support
            â€¢ Improved audio playback stability & headset control experience
            â€¢ Added support for M4A & ALAC bitrate and sample rate parsing
            â€¢ Added system tray integration and background running support
            â€¢ New: Playback state persistence (save progress, volume, and play mode when exiting)
            â€¢ New: Auto-scroll to current song in playlist when switching tracks
            â€¢ New: Song import progress indicator (view real-time progress and completion status)
            â€¢ New: Lyrics support â€” parse LRC & TTML formats, with word-by-word synchronized lyrics
            â€¢ New: Cover import â€” select an image to overwrite existing album art
            â€¢ Playback page animation optimized, more state persistence (playlist position, sidebar state)
            â€¢ Theme switching support

            <img src="https://github.com/user-attachments/assets/8d5b9065-8cd8-4b1e-bb6e-32b9ae5f0f25" height="500">
          files: release_files/*